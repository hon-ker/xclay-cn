(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9603],{8266:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/search",function(){return r(75957)}])},75957:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return L}});var a=r(85893),s=r(67294),l=r(31889),n=r(56726),o=r(19120),i=r(65880),c=r(9473),d=r(62161),u=r(84913),h=r(23330),g=r(1852),m=r(41478),p=r(96486),f=r.n(p),v=r(4869);let x=(e,t)=>{let r=(0,c.v9)(e=>e.chat.searchStatus),[a,l]=(0,s.useState)(!1),n=(0,s.useRef)(null),o=(0,c.I0)();n.current=r,(0,s.useEffect)(()=>{let r=(e,t)=>{"new_chat"!=n.current&&o((0,d.VH)({id:e,title:t}))};if(t.id&&t.newItem&&!a){l(!0);let a=async()=>{try{let a=await(0,v.TZ)(t.id);if(a.success){let{title:t,topic_id:s}=a.data;console.log(e,"historyList");let l=JSON.parse(JSON.stringify(e));l[0].title=t,l[0].newItem=!0,r(s,t),console.log(l,"listlist"),o((0,d.vK)(l))}}catch(e){console.error("Error in generating title:",e)}};a()}else t.id},[o,e,t,a])};var _=r(50733);let w=e=>{let{driverRef:t,jsonTips:r,json:a,isMobile:l,browserLanguage:n}=e,{visibleSidebar:o,visibleRightSidebar:c,setVisibleRightSidebar:d,setRightHistoryTips:u}=(0,s.useContext)(i.p),h="SEARCH_TIPS";(0,s.useEffect)(()=>{let e=(0,_.bh)(h);if(r&&"ok"!=e&&(!l||+e>1&&l||c)){let s=()=>{(0,_.PQ)(h,"ok"),setTimeout(()=>{u(3),u(4)},100)},o=(0,_.zm)({steps:[{element:"#AI_Search",popover:{title:r.search_desc.title[n],description:r.search_desc.description[n]}},{element:"#PRICE",popover:{title:r.price.title[n],description:r.price.description[n]}},{element:"#SEARCH_EXP",popover:{title:r.app_desc.title[n],description:r.app_desc.description[n]}},{element:"#SEARCH_INPUT",popover:{title:r.search_input.title[n],description:r.search_input.description[n]}}],onPrev(){1==o.getState().activeIndex&&l&&(console.log("setVisibleRightSidebar true"),d(!0)),(0,_.PQ)(h,o.getState().activeIndex-1)},onNext(){1==o.getState().activeIndex&&l&&(console.log("setVisibleRightSidebar false"),d(!1)),(0,_.PQ)(h,o.getState().activeIndex)},onComplete(){s()}});t.current=o,a&&"ok"!=e&&(1==+e&&l&&c||o.drive(e?+e:0))}},[a,u,o,c,r,n,l,d,t])},S=(e,t)=>{let[r,a]=(0,s.useState)([]),l=(0,c.I0)();return(0,s.useEffect)(()=>{let r=async e=>{try{let r=await(0,v.Rw)(e);if(r.success){let e=r.data;a(e.conv_tree),console.log("%c resultData 写入当前会话的聊天信息","color: #4CAF50; font-weight: bold"),l((0,d.fb)(e)),t&&t()}}catch(e){console.error(e)}};e.id&&2==e.newChat&&(console.log("%c resultData 选中当前历史记录->写入选中数据->发起当前数据ID请求聊天信息","color: #4CAF50; font-weight: bold"),a([]),r(e.id))},[l,e]),{conv_tree:r,setConvTree:a}};var y=r(9581),I=r(94055);let j=e=>{let{language:{browserLanguage:t}}=(0,c.v9)(e=>e),{SEARCH_TIPS:r,isMobile:s,json:l,driverRef:n}=e;return(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)("div",{className:"absolute w-[90%] flex justify-center items-center flex-col",style:{top:0,height:"calc(100% - 4.5rem)",left:"50%",marginLeft:"-45%"},children:[(0,a.jsxs)("div",{className:"mb-15 mt-15 text-center",children:[(0,a.jsx)("div",{className:"h3 leading-[4rem] 2xl:mb-2 2xl:h4 flex items-center justify-center pl-4",children:(0,a.jsx)(I.default,{placement:"bottom",title:()=>(0,a.jsxs)("div",{className:"p-2",children:[(0,a.jsx)("p",{children:"Context: 4096 tokens"}),(0,a.jsx)("p",{children:"Price: $0.02 / send"})]}),children:(0,a.jsxs)("div",{className:"flex items-center justify-center w-36",id:"PRICE",children:["Search",(0,a.jsx)("div",{className:"ml-1",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor",className:"w-6 h-6 text-gray-500",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"})})})]})})}),(0,a.jsx)("div",{className:"body1 text-n-4 2xl:bodyS",children:l&&l.SEARCH_TITTLE[t]})]}),(0,a.jsx)("div",{id:"SEARCH_EXP",children:l&&(0,a.jsx)(y.Z,{page:"search",json:l,onClick:()=>{let e=(0,_.bh)(r);"ok"!=e&&2==+e&&(n.current&&n.current.destroy(),(0,_.PQ)(r,3))}})})]})})};var b=r(68709),E=r(14328),C=r(34546),N=r(44319),T=r(98354);let P=e=>{let{conv_tree:t}=e,[r,l]=(0,s.useState)(!1),{selectChatHistory:n}=(0,c.v9)(e=>e.chat);return(0,a.jsxs)("div",{className:" flex items-center min-h-[4.5rem] px-10 py-3 md:min-h-[3.5rem] md:py-0 border-b border-n-3 shadow-[0_0.75rem_2.5rem_-0.75rem_rgba(0,0,0,0.06)] 2xl:px-6  lg:pr-20 md:pl-5 md:pr-18 dark:border-n-5 dark:shadow-[0_0.75rem_2.5rem_-0.75rem_rgba(0,0,0,0.15)] theb-header",children:[(0,a.jsx)("div",{className:"mr-auto h5 truncate md:h6 flex",id:"chat_title",children:n.title||"New Chat"}),(0,a.jsx)("div",{className:"flex relative items-center ml-6",children:n.id&&(0,a.jsx)("button",{className:"group w-8 h-8 mr-6 md:ml-3 md:mr-0 print-hide",onClick:()=>l(!0),children:(0,a.jsx)(N.Z,{className:"fill-n-4 transition-colors group-hover:fill-primary-1",name:"share"})})}),(0,a.jsx)(T.Z,{visible:r,onClose:()=>l(!1),tid:n.id,conv_tree:t,setVisibleModal:l})]})};var k=r(51900);let H=()=>{let{statusDataReset:e,setStatusDataReset:t,setRightRechargeTips:r}=(0,s.useContext)(i.p),[p,v]=(0,s.useState)(!1),_=(0,g.useMediaQuery)({query:"(max-width: 769px)"}),{searchStatus:y,chatAboutInfo:I,historyList:N,selectChatHistory:T}=(0,c.v9)(e=>e.chat),{language:{browserLanguage:H},config:{mode:M},userInfo:{globalOrgId:R}}=(0,c.v9)(e=>e),[D,A]=(0,s.useState)([]),[Z,O]=(0,s.useState)(1),[F,q]=(0,s.useState)(1),[L,V]=(0,s.useState)(),J=(0,c.I0)(),Q=(0,s.useRef)(null),{conv_tree:X,setConvTree:z}=S(T,()=>{O(Z+1),t(!1)});x(N,T);let{json:K,jsonTips:U}=(0,b.Z)();w({driverRef:Q,json:K,jsonTips:U,isMobile:_,browserLanguage:H});let $=()=>{J((0,d.Hr)({page:"search",status:"dialogue"})),L&&L.abort()},B=async e=>{let{message:a,save:s,parentId:l,regenerate:n}=e;if(Q.current&&Q.current.destroy(),"new_chat"==y&&t(!1),"responding"==y||"sending"==y)return!1;if(O(Z+1),q(F+1),""!==a.trim()||n)try{J((0,d.Hr)({page:M,status:"sending"}));let{cid1:e,cid2:t,Obj:o}=(0,k.i)({message:a,save:s,parentId:l,regenerate:n,conv_tree:X,setConvTree:z}),i=await(0,E.ve)(o);if(console.log(i,"lastCurd"),"new_chat"==y){J((0,d.VH)({title:"New Chat",id:"",newItem:!1}));let e=f().cloneDeep(I);e.topic={format_version:0,id:"",model:null,title:"",params:{},params_def:[]},console.log(e,"caInfo"),J((0,d.fb)({...e}))}let c=f().once(()=>{console.log("这个函数只会执行一次调用！"),console.log(y,"searchStatus"),J((0,d.Hr)({page:M,status:"responding"}))});console.log("%c 写入当前会话的聊天信息和占位数据","color: #4CAF50; font-weight: bold");let g=null,x=null,_=(0,u.Z)({url:"/api/search_conversation?org_id=".concat(R,"&req_rand=").concat(Math.random()),body:JSON.stringify({text:a,topic_id:"dialogue"===y?T.id:null,parent_id:T.id?await(0,k.r)({last:i,save:s,parentId:l,conv_tree:X,regenerate:n,thatLastErr:p}):null,model_params:{}},(e,t)=>"string"==typeof t?t.replace(/\\\\/g,"\\"):t),onOpen:async a=>{if(console.log(a,"onOpen data"),a.success)a.success&&v(!1);else{let{detail:s,errcode:l}=a.data,n=await(0,E.ve)({editInfo:{id:e,errcode:l},changeItem:{id:t,loading:!1,contentData:{type:1,args:{content:(0,h.Pq)(l,s)},textMerge:!0}},conv_tree:i.lastTree,setConvTree:z});$(),v(!0),A(n.lastTree),1601==l&&r(1+Math.random())}},onMessage:async r=>{let a=r.event;switch(a){case"meta":console.log("meta");try{if((x=JSON.parse(r.data))&&x.tid){let r={changeItem:{id:t,resetId:x.cid2},conv_tree:i.lastTree,setConvTree:z};if(i=n?await(0,E.ve)(r):await(0,E.ve)({editInfo:{id:e,resetId:x.cid1},...r}),A(i.lastTree),"new_chat"==y){let e={title:"New Chat",id:x.tid,newItem:!0},t=f().cloneDeep(N);t.unshift(e),J((0,d.vK)(t)),J((0,d.VH)(e))}}}catch(e){console.error("Failed to parse event data:",e);return}break;case"update":console.log(i.lastTree,"在update");try{let e=JSON.parse(r.data);i=await(0,E.ve)({editInfo:{id:x.cid1,mod_result:null==g?void 0:g.q},changeItem:{id:x.cid2,loading:!1,contentData:{...e,textMerge:!0},mod_result:null==g?void 0:g.a},conv_tree:i.lastTree,setConvTree:z}),c()}catch(e){console.error("Failed to parse event data:",e);return}break;case"mod":g=JSON.parse(r.data),console.log(g,"先mod1");break;case"end":i=await(0,E.ve)({editInfo:{id:x.cid1,mod_result:null==g?void 0:g.q},changeItem:{id:x.cid2,loading:!1,mod_result:null==g?void 0:g.a},conv_tree:i.lastTree,setConvTree:z}),A(i.lastTree),$();break;case"err":try{let e=r.data?JSON.parse(r.data):null;console.log(e,"errerrerr"),i=await(0,E.ve)({changeItem:{id:x.cid2,loading:!1,contentData:{type:1,args:{content:(0,h.Pq)(null==e?void 0:e.errcode,null==e?void 0:e.detail)},textMerge:!0},errcode:e&&(null==e?void 0:e.errcode)},conv_tree:i.lastTree,setConvTree:z}),A(i.lastTree)}catch(e){console.error(e,"error")}$()}},onError:async e=>{console.log("对话发起失败或者其他原因",e);try{let e={errcode:9999,detail:"An error occurred. Either the engine you requested does not exist or there was another issue processing your request. If this issue persists please contact us through our help center at support@theb.ai."};console.log((0,h.Pq)(e.errcode,e.detail),"errData(errMsgData.errcode, errMsgData.detail)"),i=await(0,E.ve)({errItem:{loading:!1,contentData:{type:1,args:{content:(0,h.Pq)(e.errcode,e.detail)},textMerge:!0},errcode:e.errcode},conv_tree:i.lastTree,setConvTree:z}),A(i.lastTree)}catch(e){console.error(e,"onError Error")}$()},onClose(){J((0,m.yA)()),O(Z+1)},onFinally(){console.log("onFinally"),g=null,$()}});V(_)}catch(e){console.log(e,"errorerror"),$()}};return(0,s.useEffect)(()=>{("new_chat"===y||e)&&(console.log("新聊天肯定要把输入框放出来"),v(!1),z([]),A([]),e&&t(!1)),("new_chat"===y||"dialogue"===y)&&L&&L.abort()},[e,y,z,L]),(0,s.useEffect)(()=>{let t=async()=>{let e=await(0,E.f4)(D),t=await(0,E.D6)(D);console.log(e,"errParentId"),console.log(t,"lastItem"),null==e&&v(!1),t.errcode&&v(!0)};"dialogue"==y&&T.id&&D.length>0&&!e&&t()},[X,D,y,T,e]),(0,a.jsxs)(a.Fragment,{children:[(T.id||X.length>0)&&(0,a.jsx)(P,{conv_tree:X}),(0,a.jsxs)(n.Z,{refreshDialogue:F,refresh:Z,conv_tree:X,cStatus:y,children:["new_chat"===y&&K&&(0,a.jsx)(j,{driverRef:Q,SEARCH_TIPS:"SEARCH_TIPS",json:K,isMobile:_}),X.length>0&&(0,a.jsx)(o.Z,{conv_tree:X,setConvTree:z,setLastTree:A,status:y,handleSendMessage:e=>{let{message:t,parentId:r,save:a}=e;B({message:t,parentId:r,save:a})}})]}),(0,a.jsxs)(l.Z,{handleSendMessage:e=>B({message:e}),setRefresh:e=>O(e),refresh:Z,status:y,thatLastErr:!1,domId:"SEARCH_INPUT",children:["responding"===y&&L&&(0,a.jsx)(C.$,{stop:L,MODE:M,thatLastErr:p}),"dialogue"===y&&2==I.topic.format_version&&(0,a.jsx)(C.H,{thatLastErr:p,onClick:async()=>{let e=await(0,E.uF)(X);console.log(e,"lastItem"),e&&(J((0,d.Hr)({page:M,status:"sending"})),B({message:e.content,regenerate:e.id}))}})]})]})};var M=r(55281),R=r(26565),D=r(90214),A=r(20947),Z=r(7938),O=r(86892);let F=()=>{let[e,t]=(0,s.useState)(null),[r,l]=(0,s.useState)(!0),n=(0,c.I0)();(0,A.Z)(),(0,O.Z)(()=>{n((0,m.PM)("search")),n((0,d.VH)({title:"New Chat",id:"",newItem:!1}))});let{userInfo:o}=(0,c.v9)(e=>e);return(0,s.useEffect)(()=>{let e=o.meData;e&&(t(e),l(!1))},[o]),(0,D.Z)(),console.log("search refresh"),(0,a.jsxs)(a.Fragment,{children:[r&&(0,a.jsx)(Z.Z,{}),e&&(0,a.jsx)(R.H,{children:(0,a.jsx)(M.Z,{rightSidebarMode:"search",children:(0,a.jsx)(H,{})})})]})},q=()=>(0,a.jsx)(F,{});var L=q}},function(e){e.O(0,[277,5445,1265,1664,5675,437,1098,6455,4833,2554,4749,4305,5362,9120,7703,6896,9774,2888,179],function(){return e(e.s=8266)}),_N_E=e.O()}]);